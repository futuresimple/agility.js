// Agility 0.1.2
//
// (c) 2012-2012 Future Simple
var Agility={start:function(a){a?(Backbone.history.started||Backbone.history.start({pushState:!0,silent:!0}),Backbone.history.navigate(a),Backbone.history.loadUrl(a)):(Backbone.history.started||Backbone.history.start({pushState:!0,silent:!0}),Backbone.history.loadUrl()),Backbone.history.started=!0},bootables:[],boot:function(a){Agility.bootables.push(a)},run:function(){$.each(Agility.bootables,function(a,b){b.call()})},hijackLinks:function(){$("a").live("click",function(){console.log(this.href);var a=window.location.host+"/",b=new RegExp(window.location.host);if(b.test(this.href)){var c=this.href.split(a).pop();return Monitor.Ajax.abortAll(),Backbone.history.navigate(c,!0),!1}})}};window.jQuery&&jQuery(Agility.run),Agility.Collection=Backbone.Collection.extend({}),Agility.Controller=function(a,b){var c=Agility.Controller.Base.extend(b);Agility.Controller.controllers[a]=new c},Agility.Controller.controllers={},Agility.Controller.Base=Backbone.Router.extend({useLayout:function(a,b){b=b||{};if(!Agility.State.layout||Agility.State.layout.name!=a){var c=window[Agility.Util.capitalize(a)+"LayoutView"],d=(new c(b)).renderInto(Agility.root);Agility.State.layout={instance:d,name:a}}return b.clear!=0&&Agility.State.layout.instance.clear(),Agility.State.layout.instance.update(b),this.layout=Agility.State.layout.instance,Agility.State.layout.instance}}),Agility.Model=Backbone.Model.extend({parse:function(a){return this.namespace?a[this.namespace]:a},toJSON:function(){return this.namespace?(result={},result[this.namespace]=this.attributes):result=this.attributes,result}}),Monitor={},Monitor.Ajax={requests:[],add:function(a){this.requests.push(a)},remove:function(a){var b=_.indexOf(this.requests,a);this.requests.splice(b,1)},abortAll:function(){var a=this;_.each(this.requests,function(b){b.abort(),a.remove(b)})},install:function(){$(document).ajaxSend(function(a,b){Monitor.Ajax.add(b)}).ajaxComplete(function(a,b){Monitor.Ajax.remove(b)})}},Agility.Router={_hook:function(){},executeHook:function(a,b,c){try{this._hook&&this._hook(a,b,c)}catch(d){}},setHook:function(a){this._hook=a},route:function(a,b){a=="/"&&(a="");var c=b.split("#"),d=c[0],e=Agility.Controller.controllers[d];if(!e)throw new Error("Could not find controller "+d);var f=c[1],g=e[f],h=d+"#"+f;if(!g)throw new Error("Action "+d+"#"+g+" not defined");_.isRegExp(a)||(a=e._routeToRegExp(a)),Backbone.history||(Backbone.history=new Backbone.History),Backbone.history.route(a,_.bind(function(b){Agility.Router.executeHook("/"+b,d,f);var c=e._extractParameters(a,b);g.apply(e,c),e.trigger.apply(e,["route:"+h].concat(c))},e))}},Agility.State={},Backbone.old_sync=Backbone.sync,Backbone.getUrl=function(a){if(!a||!a.url)return null;var b=_.isFunction(a.url)?a.url():a.url;return b+".json"},Backbone.sync=function(a,b,c){return c.url=Backbone.getUrl(b),Backbone.old_sync(a,b,c)},Agility.Template={collection:{},loadAll:function(){var a=$('script[type="text/x-handlebars-template"]');$.each(a,function(a,b){Agility.Template.collection[b.id.replace(/\-template/,"")]=Handlebars.compile(b.innerHTML)})},register:function(a,b){Agility.Template.collection[a]=Handlebars.compile(b)},render:function(a,b,c){return this.collection[a](b,c)}},Agility.Template.html_escape=function(a){return typeof a=="string"?a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"):typeof a=="object"&&a.html_safe?a.html_safe:a},Agility.Template.h=Agility.Template.html_escape,window.jQuery&&(jQuery.fn.render=function(a,b){var c=Agility.Template.render(a,b);$(this).html(c)}),Agility.Util={capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}},Agility.View=Backbone.View.extend({initialize:function(a){this.context=a},template:null,render:function(){return this.template&&($(this.el).html(Agility.Template.render(this.template,this.context)),this.rendered=!0),this.afterRender(),this},afterRender:function(){},appendInto:function(a){return this.rendered||this.render(),$(a).append(this.el),this.afterDOMReady&&this.afterDOMReady(),this},renderInto:function(a){return this.rendered||this.render(),$(a).html(this.el),this.afterDOMReady&&this.afterDOMReady(),this},navigate:function(a,b){Backbone.history.navigate(a,b)}}),Agility.Layout=Agility.View.extend({containers:[],container:{},clear:function(){var a=this;_.each(this.containers,function(b){a.container[b]=new Agility.Layout.Container(b,a),a.container[b].clear()})},update:function(a){}}),Agility.Layout.Container=function(a,b){this.view=b,this.el=self.$("#container-"+a)},_.extend(Agility.Layout.Container.prototype,{insert:function(){var a=this;_.each(arguments,function(b){b.renderInto?b.appendInto(a.el):typeof b=="string"&&/template:/.test(b)&&a.el.render(b.replace(/template:/,""))})},clear:function(){this.el.html("")}});